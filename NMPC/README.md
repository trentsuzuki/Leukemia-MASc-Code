# NMPC

Nonlinear Model Predictive Control for personalized 6-MP chemotherapy dose optimization.

**Location:** `~/UofT/Research/Leukemia/Code/NMPC`

## Main Thesis Script

`ga_joint_ukf_fullJostModel.m` is the **primary script used in the thesis**. It implements:
- Genetic Algorithm (GA) optimization for dose selection
- Joint Unscented Kalman Filter (UKF) for simultaneous state and parameter estimation
- Full 8-state Jost 2020 model with 4 estimated patient-specific parameters (Base, k_tr, slope, gamma)

All thesis figures are generated from results produced by this script (see `figs/` directory).

## Quick Start

Run the main script
```matlab
ga_joint_ukf_fullJostModel  % Run main thesis script
```

## Control Algorithms

| Script | Method | Model | Notes |
|--------|--------|-------|-------|
| `ga_joint_ukf_fullJostModel.m` | GA + Joint UKF | 8-state | **Main thesis script** |
| `nmpc_joint_ukf_fullJostModel.m` | NMPC + Joint UKF | 8-state | Uses MATLAB `nlmpc` |
| `nmpc_joint_ukf.m` | NMPC + Joint UKF | 6-state | Uses MATLAB `nlmpc` |
| `nmpc_dual_ukf.m` | NMPC + Dual UKF | 8-state | Uses MATLAB `nlmpc` |
| `robust_ga_joint_ukf_fullJostModel.m` | Robust MPC | 8-state | Optimizes expected cost over parameter uncertainty using sigma points |
| `ga_particle_filter_fullJostModel.m` | GA + Particle Filter | 8-state | Using particle filter instead of UKF |

## Model Specifications

**Full Jost Model (8 states):**
```
gut6MP -> blood6MP -> blood6TGN -> prol -> tr1 -> tr2 -> tr3 -> circ
```

**Estimated parameters:** Base, k_tr, slope, gamma

**Fixed parameters:** F=0.22, ka=31.2, k20=12.72, FM3=0.019, kme=9.9216, kma=2.3765

**BSA scaling:** `CL6tgn = 0.219 * BSA^1.16`

## Key Settings

| Parameter | Value |
|-----------|-------|
| Target ANC | 1.5 G/L |
| Dose bounds | 0-200 mg/day |
| Prediction horizon | 8 weeks |
| Sampling period | 7 days |

## State Estimation

| Method | Pros | Cons |
|--------|------|------|
| Joint UKF | Simpler, captures correlations | Larger covariance matrix |
| Dual UKF | Reduced computation | Decoupled estimation |
| Particle Filter | Non-Gaussian handling | Computationally expensive |
| Robust MPC | Uncertainty quantification | Higher cost |

## Results

- MAT files in results/ directory (generated by `ga_joint_ukf_fullJostModel.m`)
- Multi-patient simulations (all patients from Jost 2020 Data Sheet 1)
- Figures in `figs/` directory:
  - `*_allPatients_Outcome.png` - ANC trajectories and doses for all patients
  - `*_paramEst.png` - Parameter estimation errors over time
- Visualization scripts: `ukf_figures.m`, `generate_figures.m`

## Dependencies

- MATLAB MPC Toolbox
- Control System Toolbox
- Global Optimization Toolbox
- Parallel Computing Toolbox
